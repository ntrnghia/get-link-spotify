# Reusable workflow for syncing ZingMP3 charts to Spotify
name: Sync ZingMP3 Chart (Reusable)

on:
  workflow_call:
    inputs:
      chart_url:
        description: 'URL of the ZingMP3 chart to crawl'
        required: true
        type: string
      chart_name:
        description: 'Display name for the chart (for logging)'
        required: true
        type: string
      playlist_name:
        description: 'Name of the Spotify playlist'
        required: true
        type: string
      output_csv:
        description: 'Output CSV filename'
        required: true
        type: string
      min_file_size:
        description: 'Minimum file size in bytes to consider valid'
        required: false
        type: number
        default: 50000
    secrets:
      SPOTIFY_CLIENT_ID:
        required: true
      SPOTIFY_CLIENT_SECRET:
        required: true
      SPOTIFY_REFRESH_TOKEN:
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get latest Python version
        id: python-version
        run: |
          # Fetch latest stable Python version from GitHub API (exclude alpha/beta/rc)
          PYTHON_VER=$(curl -s https://api.github.com/repos/python/cpython/tags | \
            grep -Po '"name": "v\K[0-9.]+(?=")' | \
            grep -v -E 'a|b|rc' | \
            head -1)
          echo "version=$PYTHON_VER" >> $GITHUB_OUTPUT
          echo "Latest stable Python: $PYTHON_VER"

      - name: Set up Python ${{ steps.python-version.outputs.version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ steps.python-version.outputs.version }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Fetch ${{ inputs.chart_name }} via Vietnam proxy
        run: |
          echo "Fetching ${{ inputs.chart_name }} via Vietnam proxies..."
          echo "URL: ${{ inputs.chart_url }}"
          echo ""

          # Fetch fresh Vietnam proxies from proxyscrape API v4 (remove Windows line endings)
          proxies=$(curl -s --max-time 15 "https://api.proxyscrape.com/v4/free-proxy-list/get?request=displayproxies&protocol=http&timeout=10000&country=vn&ssl=all&anonymity=all&skip=0&limit=100" 2>/dev/null | tr -d '\r') || true

          if [ -z "$proxies" ]; then
            echo "ERROR: Failed to fetch proxy list from API"
            exit 1
          fi

          echo "Got $(echo "$proxies" | wc -l) proxies from API"
          echo ""

          success=false
          count=0
          max_attempts=20

          for proxy in $proxies; do
            count=$((count + 1))
            if [ $count -gt $max_attempts ]; then
              echo "Reached max attempts ($max_attempts)"
              break
            fi

            echo "[$count/$max_attempts] Trying proxy $proxy..."

            # Retry up to 3 times for partial data
            for retry in 1 2 3; do
              # Fetch with timeout
              curl -s --compressed --proxy "http://$proxy" --connect-timeout 10 --max-time 30 "${{ inputs.chart_url }}" -o chart_live.html 2>/dev/null || true

              # Check if we got complete chart data
              if grep -q "MusicPlaylist" chart_live.html 2>/dev/null; then
                filesize=$(wc -c < chart_live.html)
                if [ "$filesize" -gt ${{ inputs.min_file_size }} ]; then
                  echo "  SUCCESS: Got chart data ($filesize bytes)"
                  grep -o '"name":"[^"]*"' chart_live.html | head -3
                  success=true
                  break 2  # Break both loops
                else
                  echo "  Attempt $retry/3: Partial data ($filesize bytes, need >${{ inputs.min_file_size }})"
                  rm -f chart_live.html
                  sleep 1
                fi
              else
                echo "  FAIL: No chart data"
                rm -f chart_live.html
                break  # No point retrying if no data at all
              fi
            done
          done

          if [ "$success" != "true" ]; then
            echo ""
            echo "ERROR: No working proxy found after $count attempts!"
            exit 1
          fi

      - name: Run ZingChart crawler
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
        run: |
          python crawl_zingchart.py \
            --playlist \
            --headless \
            --chart-url "${{ inputs.chart_url }}" \
            --playlist-name "${{ inputs.playlist_name }}" \
            --output-csv "${{ inputs.output_csv }}"

      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ inputs.output_csv }}
          path: ${{ inputs.output_csv }}
          retention-days: 7
          if-no-files-found: ignore
