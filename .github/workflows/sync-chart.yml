# Reusable workflow for syncing ZingMP3 charts to Spotify
# Uses Python's concurrent proxy testing with caching
name: Sync ZingMP3 Chart (Reusable)

on:
  workflow_call:
    inputs:
      chart_url:
        description: 'URL of the ZingMP3 chart to crawl'
        required: true
        type: string
      chart_name:
        description: 'Display name for the chart (for logging)'
        required: true
        type: string
      playlist_name:
        description: 'Name of the Spotify playlist'
        required: true
        type: string
      output_file:
        description: 'Output Excel filename'
        required: true
        type: string
      min_file_size:
        description: 'Minimum file size in bytes to consider valid'
        required: false
        type: number
        default: 50000
      sorted_playlist_name:
        description: 'Name of second playlist sorted by Spotify popularity (optional)'
        required: false
        type: string
        default: ''
      trending_playlist_name:
        description: 'Name of third playlist sorted by rank + popularity (new & trending)'
        required: false
        type: string
        default: ''
    secrets:
      SPOTIFY_CLIENT_ID:
        required: true
      SPOTIFY_CLIENT_SECRET:
        required: true
      SPOTIFY_REFRESH_TOKEN:
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get latest Python version
        id: python-version
        run: |
          # Fetch latest stable Python version from GitHub API (exclude alpha/beta/rc)
          PYTHON_VER=$(curl -s https://api.github.com/repos/python/cpython/tags | \
            grep -Po '"name": "v\K[0-9.]+(?=")' | \
            grep -v -E 'a|b|rc' | \
            head -1)
          echo "version=$PYTHON_VER" >> $GITHUB_OUTPUT
          echo "Latest stable Python: $PYTHON_VER"

      - name: Set up Python ${{ steps.python-version.outputs.version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ steps.python-version.outputs.version }}
          cache: 'pip'

      - name: Restore caches
        uses: actions/cache/restore@v4
        with:
          path: |
            .spotify_cache.json
            .proxy_cache.json
          key: app-cache-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            app-cache-

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Sync ${{ inputs.chart_name }} to Spotify
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
        run: |
          python main.py \
            --live \
            --playlist \
            --headless \
            --chart-url "${{ inputs.chart_url }}" \
            --playlist-name "${{ inputs.playlist_name }}" \
            --output-file "${{ inputs.output_file }}" \
            --min-file-size ${{ inputs.min_file_size }} \
            ${{ inputs.sorted_playlist_name && format('--sorted-playlist-name "{0}"', inputs.sorted_playlist_name) || '' }} \
            ${{ inputs.trending_playlist_name && format('--trending-playlist-name "{0}"', inputs.trending_playlist_name) || '' }}

      - name: Upload Excel artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ inputs.output_file }}
          path: ${{ inputs.output_file }}
          retention-days: 7
          if-no-files-found: ignore

      - name: Delete old cache
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh cache delete "app-cache-${{ hashFiles('requirements.txt') }}" --repo ${{ github.repository }} || true

      - name: Save caches
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            .spotify_cache.json
            .proxy_cache.json
          key: app-cache-${{ hashFiles('requirements.txt') }}
