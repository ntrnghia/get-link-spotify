# Sync ZingMP3 Top 100 to Spotify
name: Update ZingMP3 Playlist

on:
  schedule:
    - cron: '0 * * * *'  # Every hour at minute 0
  workflow_dispatch:  # Manual trigger from GitHub UI

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python (latest)
        uses: actions/setup-python@v6
        with:
          python-version-file: '.python-version'
          cache: 'pip'  # Built-in pip caching

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Fetch ZingChart via Vietnam proxy
        run: |
          echo "Fetching Vietnam proxies from proxyscrape API..."

          # Fetch fresh Vietnam proxies from proxyscrape API (remove Windows line endings)
          proxies=$(curl -s --max-time 15 "https://api.proxyscrape.com/v2/?request=displayproxies&protocol=http&timeout=10000&country=vn" 2>/dev/null | tr -d '\r') || true

          if [ -z "$proxies" ]; then
            echo "ERROR: Failed to fetch proxy list from API"
            exit 1
          fi

          echo "Got $(echo "$proxies" | wc -l) proxies from API"
          echo ""

          success=false
          count=0
          max_attempts=20

          for proxy in $proxies; do
            count=$((count + 1))
            if [ $count -gt $max_attempts ]; then
              echo "Reached max attempts ($max_attempts)"
              break
            fi

            echo "[$count/$max_attempts] Trying proxy $proxy..."

            # Fetch with timeout
            curl -s --compressed --proxy "http://$proxy" --connect-timeout 10 --max-time 30 "https://zingmp3.vn/zing-chart" -o chart_live.html 2>/dev/null || true

            # Check if we got chart data
            if grep -q "MusicPlaylist" chart_live.html 2>/dev/null; then
              echo "SUCCESS: Got chart data from $proxy ($(wc -c < chart_live.html) bytes)"
              grep -o '"name":"[^"]*"' chart_live.html | head -3
              success=true
              break
            else
              echo "FAIL: No chart data"
              rm -f chart_live.html
            fi
          done

          if [ "$success" != "true" ]; then
            echo ""
            echo "ERROR: No working proxy found after $count attempts!"
            exit 1
          fi

      - name: Run ZingChart crawler
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
        run: python crawl_zingchart.py --playlist --headless

      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zingchart-results
          path: zingchart_spotify.csv
          retention-days: 7
          if-no-files-found: ignore
